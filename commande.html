<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SecurityNoPhone ‚Äì Commande</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="flags/flags.css">
  <link rel="stylesheet" href="style_optimized.css">
</head>

<body>

  <div id="navbar-container"></div>


  <main class="container my-5">
    <div class="border rounded-4 shadow-sm p-4 bg-white mt-5">
      <h1 class="text-center mb-5">Passer une commande</h1>
      <div class="row">
        <div class="col-md-6">
          <form action="https://formspree.io/f/xqaqogdv" method="POST" id="orderForm">
            <input type="text" name="_gotcha" style="display:none">
            <div class="mb-3">
              <label class="form-label" data-i18n="label_offer_type">Type d‚Äôoffre :</label>
              <select class="form-select" name="offre" id="offerType" required>
                <option value="" data-i18n="option_choose_offer">-- Choisir une offre --</option>
                <option value="location_sans" data-i18n="option_location_without">Location sans personnel</option>
                <option value="location_avec" data-i18n="option_location_with">Location avec personnel</option>
                <option value="achat" data-i18n="option_custom_pouches">Pochettes personnalis√©es</option>
                <option value="abonnement" data-i18n="option_subscription">Abonnement Starter</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="quantity" class="form-label" data-i18n="label_quantity">Quantit√© de pochettes :</label>
              <input type="number" class="form-control" name="quantite" id="quantity" max="250" min="1" value="50" required />
              <div id="quantityError" class="text-danger mt-1" style="display: none;"></div>
            </div>
            <div class="mb-3">
              <label for="date" class="form-label" data-i18n="label_date">Date de l'√©v√©nement :</label>
              <input type="date" name="date" id="date" class="form-control" required />
              <div id="dateError" class="text-danger mt-1" style="display: none;"></div>
            </div>
            <div class="mb-3"><label for="nom" class="form-label" data-i18n="label_fullname">Nom complet :</label>
              <input type="text" name="nom" id="nom" class="form-control" required />
            </div>
            <div class="mb-3"><label for="email" class="form-label" data-i18n="label_email_form">Email :</label> <input
                type="email" name="email" id="email" class="form-control" required />
            </div>
            <div class="mb-3"><label for="adresse" class="form-label" data-i18n="label_address">Adresse de facturation :</label>
              <textarea name="adresse" id="adresse" class="form-control" required></textarea>
            </div>
            <div class="price-box text-center fw-bold fs-5 my-3" id="priceDisplay" data-i18n-base-text="price_total"></div>
          
            <div id="formSubmissionFeedback" class="mt-3"></div>
          
            <div class="text-center mt-4">
              <button type="submit" class="btn btn-primary" data-i18n="btn_submit_order">Valider la commande</button>
            </div> </form>
        </div>
        <div class="col-md-6 d-flex flex-column justify-content-center align-items-center px-3">
          <div class="bg-light rounded-4 shadow-sm p-4 w-100">
            <p class="text-center fw-semibold fs-5 mb-3 text-dark">üí≥ Paiement en <strong>4 fois sans frais</strong>
              avec PayPal<br>
              <small class="fst-italic text-muted">(sous r√©serve d‚Äô√©ligibilit√©)</small>
            </p>
            <p class="text-center text-secondary">
              Prot√©gez la confidentialit√© de vos √©v√©nements gr√¢ce √† notre option de paiement en plusieurs fois.<br>
              <span class="text-dark">L‚Äôoption s‚Äôaffiche automatiquement lors du paiement via PayPal si vous √™tes
                √©ligible.</span>
            </p>
            <hr class="my-3 bg-secondary" style="height:1px; width:80%;" />
            <p class="text-center text-dark">
              <strong>Nos offres flexibles :</strong><br>
              ‚Ä¢ Location cl√©-en-main (avec ou sans personnel)<br>
              ‚Ä¢ Pochettes personnalis√©es pour vos √©v√©nements<br>
              ‚Ä¢ Abonnement Starter pour une solution durable
            </p>
            <p class="fw-bold mt-4 text-center" style="color: #198754;">
              Commandez aujourd‚Äôhui, payez sereinement,<br>et garantissez la r√©ussite de votre √©v√©nement.
            </p>
            <small class="d-block text-center mt-3 text-muted">
              üí° Astuce : le paiement en plusieurs fois vous sera propos√© automatiquement √† l‚Äô√©tape de validation.
            </small>
          </div>
        </div>
      </div>
    </div>
  </main>

 <!-- Footer inclus dynamiquement -->
<div id="footer-container"></div>

<!-- Scripts principaux -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>AOS.init();</script>

<!-- Traductions et logique principale -->
<script src="js/translations.js"></script>

<!-- Forcer la langue souhait√©e (modifie selon la page) -->
<script>
  localStorage.setItem("lang", "fr"); // change en "de", "en", "ar" selon la page
</script>

<script src="js/main.js"></script>

<!-- Mise √† jour dynamique du prix (si formulaire pr√©sent sur la page) -->
<script>// DANS LE SCRIPT DE commande.html
  document.addEventListener("DOMContentLoaded", () => {
    const offerType = document.getElementById('offerType');
    const quantityInput = document.getElementById('quantity'); // Renomm√© pour clart√©
    const priceDisplay = document.getElementById('priceDisplay');
    const dateInput = document.getElementById('date');
    const orderForm = document.getElementById('orderForm');
    const quantityError = document.getElementById('quantityError');
    const dateError = document.getElementById('dateError');
    const formSubmissionFeedback = document.getElementById('formSubmissionFeedback');
    const basePriceText = priceDisplay.getAttribute('data-i18n-base-text') || "price_total"; // Utilise la cl√© i18n

    function validateQuantity() {
      const qty = parseInt(quantityInput.value);
      const type = offerType.value;
      let isValid = true;
      let errorMessage = "";
      const currentTranslations = window.translations[localStorage.getItem('lang') || 'fr'] || {};

      if (type === 'achat' && qty < 50) {
        isValid = false;
        errorMessage = currentTranslations["alert_min_quantity_achat"] || "Pour les pochettes personnalis√©es, le minimum est de 50 unit√©s."; // Ajoutez cette cl√© √† translations.js
      } else if (qty > 250) {
        isValid = false;
        errorMessage = currentTranslations["alert_max_quantity"] || "La quantit√© maximale autoris√©e est de 250 pochettes.";
      }

      quantityError.textContent = errorMessage;
      quantityError.style.display = isValid ? "none" : "block";
      return isValid;
    }

    function validateDate() {
      const today = new Date().toISOString().split('T')[0];
      let isValid = true;
      let errorMessage = "";
      const currentTranslations = window.translations[localStorage.getItem('lang') || 'fr'] || {};

      if (dateInput.value < today) {
        isValid = false;
        errorMessage = currentTranslations["alert_date_past"] || "La date de l'√©v√©nement ne peut pas √™tre dans le pass√©."; // Ajoutez √† translations.js
      }
      dateError.textContent = errorMessage;
      dateError.style.display = isValid ? "none" : "block";
      return isValid;
    }

    function updatePrice() {
      const type = offerType.value;
      const qty = parseInt(quantityInput.value) || 0;
      let total = 0;
      const currentTranslations = window.translations[localStorage.getItem('lang') || 'fr'] || {};

      if (qty <= 0 && type !== 'abonnement' && type !== 'location_sans' && type !== 'location_avec') { // Ne pas calculer si quantit√© invalide sauf pour abo/loc fixe
        priceDisplay.innerHTML = ""; // Ou un message invitant √† s√©lectionner
        return;
      }

      if (type === 'location_sans') total = 150; // Prix corrig√© comme sur la page d'accueil
      else if (type === 'location_avec') total = 390;
      else if (type === 'achat') total = qty >= 50 ? qty * 3.5 : 0; // Le prix est 0 si < 50, mais la validation l'emp√™chera
      else if (type === 'abonnement') total = qty > 0 ? Math.ceil(qty / 50) * 19 : 19; // Si qt√© non pr√©cis√©e pour abo, on prend 1 pack de 50? Ou rendre qt√© non applicable pour abo.
      // Ici, j'assume que qt√© pour abo = nb de lots de 50 pochettes. Si 0, 19‚Ç¨ par d√©faut.

      const priceTextTemplate = currentTranslations[basePriceText] || "Total : {price} ‚Ç¨";
      priceDisplay.innerHTML = priceTextTemplate.replace("{price}", total.toFixed(2));
    }

    if (offerType && quantityInput && priceDisplay) {
      offerType.addEventListener('change', () => { validateQuantity(); updatePrice(); });
      quantityInput.addEventListener('input', () => { validateQuantity(); updatePrice(); });
      if (dateInput) dateInput.addEventListener('change', validateDate);

      // Appel initial
      validateQuantity();
      validateDate(); // Si vous voulez valider la date au chargement (si elle est pr√©-remplie)
      updatePrice();
    }

    if (orderForm) {
      orderForm.addEventListener('submit', function (event) {
        event.preventDefault(); // Emp√™che la soumission classique
        formSubmissionFeedback.innerHTML = ""; // Reset feedback

        const isQtyValid = validateQuantity();
        const isDateValid = dateInput ? validateDate() : true;

        if (!isQtyValid || !isDateValid || !orderForm.checkValidity()) {
          // Bootstrap g√®re d√©j√† l'affichage des erreurs pour les champs `required` via checkValidity()
          // Mais on peut forcer un message g√©n√©ral si besoin
          const currentTranslations = window.translations[localStorage.getItem('lang') || 'fr'] || {};
          formSubmissionFeedback.innerHTML = `<div class="alert alert-danger">${currentTranslations["alert_form_invalid"] || "Veuillez corriger les erreurs dans le formulaire."}</div>`; // Ajoutez √† translations.js
          return;
        }

        // Indicateur de chargement
        const submitButton = orderForm.querySelector('button[type="submit"]');
        const originalButtonText = submitButton.innerHTML;
        const currentTranslations = window.translations[localStorage.getItem('lang') || 'fr'] || {};
        submitButton.disabled = true;
        submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ${currentTranslations["text_sending"] || "Envoi..."}`; // Ajoutez √† translations.js


        const formData = new FormData(orderForm);
        fetch(orderForm.action, {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'application/json'
          }
        }).then(response => {
          if (response.ok) {
            formSubmissionFeedback.innerHTML = `<div class="alert alert-success">${currentTranslations["alert_form_success"] || "Commande envoy√©e avec succ√®s ! Nous vous contacterons bient√¥t."}</div>`; // Ajoutez √† translations.js
            orderForm.reset(); // Vide le formulaire
            updatePrice(); // Remet le prix √† son √©tat initial
          } else {
            response.json().then(data => {
              let errorMessage = currentTranslations["alert_form_error_generic"] || "Une erreur s'est produite."; // Ajoutez
              if (data.errors) {
                errorMessage = data.errors.map(error => error.message).join(", ");
              }
              formSubmissionFeedback.innerHTML = `<div class="alert alert-danger">${errorMessage}</div>`;
            })
          }
        }).catch(error => {
          formSubmissionFeedback.innerHTML = `<div class="alert alert-danger">${currentTranslations["alert_form_error_network"] || "Erreur r√©seau. Veuillez r√©essayer."}</div>`; // Ajoutez
        }).finally(() => {
          submitButton.disabled = false;
          submitButton.innerHTML = originalButtonText;
        });
      });
    }
    // Assurer que la langue est appliqu√©e aux √©l√©ments dynamiques du formulaire au chargement
    if (typeof switchLanguage === "function") {
      // Il faut s'assurer que switchLanguage peut aussi traduire les options des <select> si n√©cessaire,
      // ou que les data-i18n sur les <option> suffisent.
      // switchLanguage(); // D√©j√† appel√© globalement par main.js
    }
  });
</script>